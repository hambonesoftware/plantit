# MVVM Contracts

This document captures the view ↔ view model interaction points for the Plantit
experience.  It defines the observable state that each view model exposes to its
view and the events that the view raises back to the view model.  All view models
share the following conventions:

- Every event handler returns `Promise<void>` to enable async effects without
  blocking the UI thread.
- View models expose readonly snapshots of state through simple serializable
  objects so they can be logged or cached easily.
- All commands accept a `correlationId` generated by the frontend service layer
  so that requests may be traced end-to-end.

## Dashboard View

### ViewModel ➜ View data

| Field | Type | Description |
| --- | --- | --- |
| `summary` | `DashboardSummary` | Hero metrics including total plants, villages and success rate. |
| `alerts` | `DashboardAlert[]` | High priority notifications (watering overdue, pests detected). |
| `isRefreshing` | `boolean` | Indicates when the dashboard data is being refreshed. |
| `lastUpdated` | `string` (ISO timestamp) | When the summary payload was last fetched. |

`DashboardSummary` structure:

```ts
interface DashboardSummary {
  totalPlants: number;
  activeVillages: number;
  successRate: number; // 0..1
  upcomingTasks: number;
}
```

`DashboardAlert` structure:

```ts
interface DashboardAlert {
  id: string;
  level: 'info' | 'warning' | 'critical';
  message: string;
  relatedPlantId?: string;
}
```

### View ➜ ViewModel events

| Event | Payload | Description |
| --- | --- | --- |
| `onInit(correlationId)` | `{ correlationId: string }` | Trigger initial load when the view first mounts. |
| `onRefresh(correlationId)` | `{ correlationId: string }` | User requested a manual refresh. |
| `onAcknowledgeAlert(alertId, correlationId)` | `{ alertId: string; correlationId: string }` | Dismisses a surfaced alert. |

## Villages View

### ViewModel ➜ View data

| Field | Type | Description |
| --- | --- | --- |
| `villages` | `VillageSummary[]` | List of available plant villages. |
| `selectedVillageId` | `string \| null` | Currently highlighted village. |
| `isLoading` | `boolean` | Indicates when the village list is loading. |
| `filters` | `VillageFilterState` | Active filter controls (climate zone, size). |

`VillageSummary` structure:

```ts
interface VillageSummary {
  id: string;
  name: string;
  climate: string;
  plantCount: number;
  healthScore: number; // 0..1
}
```

`VillageFilterState` structure:

```ts
interface VillageFilterState {
  searchTerm: string;
  climateZones: string[];
  minHealth: number | null;
}
```

### View ➜ ViewModel events

| Event | Payload | Description |
| --- | --- | --- |
| `onInit(correlationId)` | `{ correlationId: string }` | Fetch villages on first render. |
| `onSelectVillage(villageId, correlationId)` | `{ villageId: string; correlationId: string }` | User selected a village to inspect. |
| `onFilterChange(filters, correlationId)` | `{ filters: VillageFilterState; correlationId: string }` | Update filters and refresh data. |

## Today View

### ViewModel ➜ View data

| Field | Type | Description |
| --- | --- | --- |
| `tasks` | `DailyTask[]` | Tasks scheduled for today across villages. |
| `isLoading` | `boolean` | True while tasks are being fetched. |
| `emptyStateMessage` | `string \| null` | Optional guidance when no tasks exist. |

`DailyTask` structure:

```ts
interface DailyTask {
  id: string;
  type: 'water' | 'fertilize' | 'inspect' | 'transplant';
  plantId: string;
  plantName: string;
  villageName: string;
  dueAt: string; // ISO timestamp
  priority: 'low' | 'medium' | 'high';
}
```

### View ➜ ViewModel events

| Event | Payload | Description |
| --- | --- | --- |
| `onInit(correlationId)` | `{ correlationId: string }` | Load today's tasks on mount. |
| `onCompleteTask(taskId, correlationId)` | `{ taskId: string; correlationId: string }` | Mark a task complete and refresh list. |
| `onSnoozeTask(taskId, minutes, correlationId)` | `{ taskId: string; minutes: number; correlationId: string }` | Snooze a task into the future. |

## Plant Modal

### ViewModel ➜ View data

| Field | Type | Description |
| --- | --- | --- |
| `plant` | `PlantDetail \| null` | Detailed information for the focused plant. |
| `timeline` | `PlantEvent[]` | Chronological events for the plant. |
| `isLoading` | `boolean` | Indicates when the detail request is in-flight. |
| `error` | `string \| null` | Populated when fetching data fails. |

`PlantDetail` structure:

```ts
interface PlantDetail {
  id: string;
  displayName: string;
  species: string;
  villageName: string;
  lastWateredAt: string;
  healthScore: number; // 0..1
  notes: string;
}
```

`PlantEvent` structure:

```ts
interface PlantEvent {
  id: string;
  occurredAt: string; // ISO timestamp
  type: 'watering' | 'fertilizer' | 'inspection' | 'transfer' | 'note';
  summary: string;
}
```

### View ➜ ViewModel events

| Event | Payload | Description |
| --- | --- | --- |
| `onOpen(plantId, correlationId)` | `{ plantId: string; correlationId: string }` | Triggered when modal opens for a plant. |
| `onRefresh(correlationId)` | `{ correlationId: string }` | Refresh details while modal is open. |
| `onClose()` | `{}` | Clear state when the modal closes. |
| `onAppendNote(note, correlationId)` | `{ note: string; correlationId: string }` | Append a note to the plant timeline. |

## Shared Types

The frontend service layer exposes these shapes verbatim through its typed
helpers (see `frontend/services/api.js`).  Backend service contracts mirror the
same structures for parity between the two tiers.
